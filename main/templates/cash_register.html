{% extends "base.html" %}

{% block title %}Kasse{% endblock title %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 80px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
    <h1 style="text-align:center; margin-bottom: 20px;">Kasse</h1>
    <h2 style="text-align:center; margin-bottom: 30px;">Aktuelles Geld: <span id="income">{{ income }}</span>€</h2>
    
    <input type="number" id="order-search" placeholder="Kundennummer suchen..." style="width:100%; padding:10px; margin-bottom:25px; border-radius:6px; border:1px solid #ccc;">

    <div id="connection" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
        <p id="connection-status" style="margin: 0; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: red; border: 1px solid red;">
            Nicht verbunden oder Verbindung wird aufgebaut…
        </p>
        <a href="{% url 'pay_Screen' %}" style="display:block; margin-top:5px;">Diese Instanz als Bildschirm nutzen</a>
    </div>

    <div id="orders" style="color=black">
        {% for order in orders %}
            <div class="order-card" id="order-{{ order.id }}" data-customer-id="{{ order.customer.id }}" style="background:#f9f9f9; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <p style="font-weight:bold; margin-bottom:8px;">Kunde #{{ order.customer.id }} - {{ order.price }}€</p>
                <p style="margin-bottom:10px;">
                    {% for product in order.orderitem_set.all %}
                        {{ product.product.name }} x{{ product.quantity }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <button class="display-pay-button" data-order-id="{{ order.id }}" style="padding:6px 12px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer;">Auf Bildschirm anzeigen</button>
            </div>
        {% endfor %}
    </div>
</div>

<div id="popup" style="
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4caf50;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    display: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
"></div>

<script>
let socket = null;
const popup = document.getElementById('popup');

function updateConnectionStatus(state) {
    const statusEl = document.getElementById("connection-status");
    const colors = {connected:"rgba(45,210,0,1)", disconnected:"red", connecting:"orange", closing:"darkorange"};
    statusEl.textContent = {
        connected:"Live-Server verbunden (click to reconnect)",
        disconnected:"Nicht verbunden (click to reconnect)",
        connecting:"Verbindung wird aufgebaut…",
        closing:"Verbindung wird geschlossen…"
    }[state];
    statusEl.style.color = colors[state];
    statusEl.style.borderColor = colors[state];
}

function connectSocket() {
    updateConnectionStatus("connecting");
    socket = new WebSocket(`${window.location.protocol==='https:'?'wss':'ws'}://${window.location.host}/ws/pay/`);
    socket.onopen = () => updateConnectionStatus("connected");
    socket.onclose = () => updateConnectionStatus("disconnected");
    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if(data.paid_order_id){
            const el = document.getElementById(`order-${data.paid_order_id}`);
            if(el) el.remove();
        }
        if(data.orders){
            const ordersContainer = document.getElementById("orders");
            ordersContainer.innerHTML = "";
            data.orders.forEach(order => {
                const items = order.items.map(i => `${i.name} x${i.quantity}`).join(", ");
                const div = document.createElement("div");
                div.className = "order-card";
                div.id = `order-${order.id}`;
                div.dataset.customerId = order.customer_id;
                div.style = "background:#f9f9f9; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05); color:black;";
                div.innerHTML = `
                    <p style="font-weight:bold; margin-bottom:8px;">Kunde #${order.customer_id} - ${order.price}€</p>
                    <p style="margin-bottom:10px;">${items}</p>
                    <button class="display-pay-button" data-order-id="${order.id}" style="padding:6px 12px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer;">Auf Bildschirm anzeigen</button>
                `;
                ordersContainer.appendChild(div);
            });
            document.getElementById("income").textContent = data.income;
        }
    };
}

connectSocket();

function displayOrder(orderDiv){
    const button = orderDiv.querySelector('.display-pay-button');
    const orderId = button.dataset.orderId;
    if(!button.dataset.displaying){
        fetch(`/display_order/${orderId}/`,{method:"GET", headers:{"X-CSRFToken":"{{ csrf_token }}"}})
        .then(()=>{
            button.textContent="NOW DISPLAYING ON SCREEN - REMOVE?";
            button.dataset.displaying="true";

            const paidBtn = document.createElement("button");
            paidBtn.textContent="Als bezahlt markieren";
            paidBtn.dataset.orderId=orderId;
            paidBtn.style.cssText="margin-left:10px;padding:6px 12px;border:none;border-radius:5px;background:#2196f3;color:white;cursor:pointer;";
            orderDiv.appendChild(paidBtn);
            paidBtn.addEventListener("click",()=>markPaid(orderId));

            button.addEventListener("click",function removeHandler(){
                fetch('/rmfps/',{method:'GET', headers:{'X-CSRFToken':'{{ csrf_token }}'}})
                .then(()=>{
                    button.textContent="Auf Bildschirm anzeigen";
                    delete button.dataset.displaying;
                    paidBtn.remove();
                    button.removeEventListener("click",removeHandler);
                });
            });

            const ordersContainer=document.getElementById('orders');
            ordersContainer.prepend(orderDiv);

            popup.textContent=`Kunde #${orderDiv.dataset.customerId} auf Bildschirm!`;
            popup.style.display='block';
            setTimeout(()=>{popup.style.display='none';},2000);
        });
    }
}

function markPaid(orderId){
    fetch(`/pay/${orderId}/`,{method:'GET', headers:{"X-CSRFToken":"{{ csrf_token }}"}})
    .then(res=>res.json())
    .then(data=>{
        if(data.status==="ok"){
            const el=document.getElementById(`order-${orderId}`);
            if(el) el.remove();
            popup.textContent=`Kunde #${orderId} als bezahlt markiert!`;
            popup.style.display='block';
            setTimeout(()=>{popup.style.display='none';},2000);
        }
    });
}

document.addEventListener("click",function(e){
    if(e.target.classList.contains("display-pay-button")){
        displayOrder(e.target.closest('.order-card'));
    }
});

document.getElementById("connection-status").addEventListener("click",()=>{
    if(socket && socket.readyState===WebSocket.OPEN){
        updateConnectionStatus("closing");
        socket.close();
    } else if(!socket || socket.readyState===WebSocket.CLOSED){
        connectSocket();
    }
});

const searchInput=document.getElementById('order-search');
let searchTimeout=null;
searchInput.addEventListener('input',function(){
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(()=>{
        const value=searchInput.value.trim();
        if(!value) return;
        const searchNumber=Number(value);
        document.querySelectorAll('.order-card').forEach(div=>{
            if(Number(div.dataset.customerId)===searchNumber){
                displayOrder(div);
                searchInput.value='';
            }
        });
    },300);
});
</script>
{% endblock content %}
