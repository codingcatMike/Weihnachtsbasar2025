{% extends "base.html" %}

{% block title %}Kasse{% endblock title %}

{% block content %}

<div class="container" style="max-width: 900px; margin: 80px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
    <h1 style="text-align:center; margin-bottom: 20px;">Kasse</h1>
    <h2 style="text-align:center; margin-bottom: 30px;">Aktueller Kassenstand: <span id="income">{{ income }}</span>€</h2>

    <input type="number" id="order-search" placeholder="Kundennummer suchen..." style="width:100%; padding:10px; margin-bottom:25px; border-radius:6px; border:1px solid #ccc;">
    
    <div id="connection" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
        <p id="connection-status" style="margin: 0; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: red; border: 1px solid red;">
            Nicht verbunden oder Verbindung wird aufgebaut…
        </p>
        <a href="{% url 'pay_Screen' %}" style="display:block; margin-top:5px;">Diese Instanz als Bildschirm nutzen</a>
    </div>

    <div id="orders" style="color:black">
        {% for order in orders %}
            <div class="order-card" id="order-{{ order.id }}" data-customer-id="{{ order.customer.id }}" style="background:#f9f9f9; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <p style="font-weight:bold; margin-bottom:8px;">Kunde #{{ order.customer.id }} - <span> {{ order.price }} </span>€ [{{order.id}}]</p>
                <p style="margin-bottom:10px;">
                    {% for product in order.orderitem_set.all %}
                        {{ product.product.name }} x{{ product.quantity }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>

                <input type="text" class="cupon-input" placeholder="Cupon Code eingeben" autocomplete="off" style="margin-bottom:10px; padding:6px 8px; width:100%; border-radius:5px; border:1px solid #ccc; color: black">

                <button class="display-pay-button" data-order-id="{{ order.id }}" style="padding:6px 12px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer;">Auf Bildschirm anzeigen</button>
            </div>
        {% endfor %}
    </div>

    <div id="pay-sb-form" style="margin-bottom: 30px; padding: 15px; border:1px solid #ccc; border-radius:8px; background:#f4f4f4;">
        <h3>Erstattung</h3>
        <input type="text" id="sb-reason" placeholder="Grund" style="padding:6px 8px; width:30%; margin-right:10px; border-radius:5px; border:1px solid #ccc;">
        <input type="number" id="sb-price" placeholder="Betrag (€)" style="padding:6px 8px; width:20%; margin-right:10px; border-radius:5px; border:1px solid #ccc;">
        <input type="password" id="sb-password" placeholder="Passwort" style="padding:6px 8px; width:20%; margin-right:10px; border-radius:5px; border:1px solid #ccc;">
        <button id="pay-sb-btn" style="padding:6px 12px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer;">Bezahlen</button>
    </div>

    {% if happyhour %}
        <button onclick="toggleHappyHour()" class="hh-active">Happy Hour Ausschalten</button>
    {% else %}
        <button onclick="toggleHappyHour()" class="hh-inactive">Happy Hour Einschalten</button>
    {% endif %}
</div>

<div id="popup" style="
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4caf50;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    display: none;
    box-shadow: 0 2 6px rgba(0,0,0,0.2);
    z-index: 1000;
"></div>

<script>
let socket = null;
const popup = document.getElementById('popup');

function updateConnectionStatus(state) {
    const statusEl = document.getElementById("connection-status");
    const colors = {connected:"rgba(45,210,0,1)", disconnected:"red", connecting:"orange", closing:"darkorange"};
    statusEl.textContent = {
        connected:"Live-Server verbunden (click to reconnect)",
        disconnected:"Nicht verbunden (click to reconnect)",
        connecting:"Verbindung wird aufgebaut…",
        closing:"Verbindung wird geschlossen…"
    }[state];
    statusEl.style.color = colors[state];
    statusEl.style.borderColor = colors[state];
}

function connectSocket() {
    updateConnectionStatus("connecting");
    socket = new WebSocket(`${window.location.protocol==='https:'?'wss':'ws'}://${window.location.host}/ws/pay/`);
    socket.onopen = () => updateConnectionStatus("connected");
    socket.onclose = () => updateConnectionStatus("disconnected");
    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if(data.paid_order_id){
            const el = document.getElementById(`order-${data.paid_order_id}`);
            if(el) el.remove();
        }
        if(data.orders){
            const ordersContainer = document.getElementById("orders");
            ordersContainer.innerHTML = "";
            data.orders.forEach(order => {
                const items = order.items.map(i => `${i.name} x${i.quantity}`).join(", ");
                const div = document.createElement("div");
                div.className = "order-card";
                div.id = `order-${order.id}`;
                div.dataset.customerId = order.customer_id;
                div.style = "background:#f9f9f9; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2 8px rgba(0,0,0,0.05); color:black;";
                div.innerHTML = `
                    <p style="font-weight:bold; margin-bottom:8px;">Kunde #${order.customer_id} - ${order.price}€</p>
                    <p style="margin-bottom:10px;">${items}</p>
                    <input type="text" class="cupon-input" placeholder="Cupon Code eingeben" style="margin-bottom:10px; padding:6px 8px; width:100%; border-radius:5px; border:1px solid #ccc;">
                    <button class="display-pay-button" data-order-id="${order.id}" style="padding:6px 12px; border:none; border-radius:5px; background:#4caf50; color:white; cursor:pointer;">Auf Bildschirm anzeigen</button>
                `;
                ordersContainer.appendChild(div);
            });
            document.getElementById("income").textContent = data.income;
        }
    };
}

connectSocket();

// Safe displayOrder function
function displayOrder(orderDiv){
    if(!orderDiv || !orderDiv.querySelector) return;
    const button = orderDiv.querySelector('.display-pay-button');
    const cuponInput = orderDiv.querySelector('.cupon-input');
    const orderId = button.dataset.orderId;

    if(button.dataset.displaying) return;

    const cuponCode = cuponInput ? cuponInput.value.trim() : null;
    let url = `/display_order/${orderId}/`;
    if(cuponCode) url += `?cupon=${encodeURIComponent(cuponCode)}`;

    fetch(url, {method:"GET", headers:{"X-CSRFToken":"{{ csrf_token }}"}})
    .then(resp => resp.json())
    .then(data => {
        if(data.status !== "ok"){
            popup.textContent = "Fehler beim Anzeigen der Bestellung!";
            popup.style.display = 'block';
            setTimeout(()=>{popup.style.display='none';},2000);
            return;
        }
        if(cuponInput) cuponInput.disabled = true;
        button.textContent="NOW DISPLAYING ON SCREEN - REMOVE";
        button.dataset.displaying="true";

        if(data.order_id && data.discount > 0){
            const discountInfo = document.createElement("div");
            discountInfo.className = "discount-info";
            discountInfo.style.cssText="margin-top:5px;color:green;font-weight:bold;";
            discountInfo.textContent = `Rabatt: -${data.discount.toFixed(2)} € → Endpreis: ${data.discounted_price.toFixed(2)} €`;
            orderDiv.appendChild(discountInfo);
        }

        const paidBtn = document.createElement("button");
        paidBtn.textContent="Als bezahlt markieren";
        paidBtn.dataset.orderId = orderId;
        paidBtn.style.cssText="margin-left:10px;padding:6px 12px;border:none;border-radius:5px;background:#2196f3;color:white;cursor:pointer;";
        orderDiv.appendChild(paidBtn);

        paidBtn.addEventListener("click", () => markPaid(orderId, cuponCode));

        button.addEventListener("click", function removeHandler(){
            fetch('/rmfps/',{method:'GET', headers:{'X-CSRFToken':'{{ csrf_token }}'}})
            .then(()=>{
                button.textContent="Auf Bildschirm anzeigen";
                delete button.dataset.displaying;
                paidBtn.remove();
                const discountInfo = orderDiv.querySelector(".discount-info");
                if(discountInfo) discountInfo.remove();
                if(cuponInput) cuponInput.disabled = false;
                button.removeEventListener("click",removeHandler);
            });
        });

        const ordersContainer=document.getElementById('orders');
        ordersContainer.prepend(orderDiv);

        popup.textContent=`Kunde #${orderDiv.dataset.customerId} auf Bildschirm!`;
        popup.style.display='block';
        setTimeout(()=>{popup.style.display='none';},2000);
    });
}

// Event delegation for display buttons
document.getElementById("orders").addEventListener("click", function(e){
    const btn = e.target.closest(".display-pay-button");
    if(!btn) return;
    const orderDiv = btn.closest(".order-card");
    displayOrder(orderDiv);
});

// Mark paid logic
function markPaid(orderId, cuponCode = null){
    let url = `/pay/${orderId}/`;
    if(cuponCode) url += `${cuponCode}/`;
    fetch(url, {
        method: 'GET',
        headers: {"X-CSRFToken": "{{ csrf_token }}"}
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === "ok"){
            const el = document.getElementById(`order-${orderId}`);
            if(el) el.remove();
            popup.textContent = `Kunde #${orderId} als bezahlt markiert!`;
        } else if(data.status === "not_valid_cupon") {
            popup.textContent = `Ungültiger Coupon! Bitte prüfen.`;
        } else {
            popup.textContent = `Fehler beim Bezahlen der Bestellung.`;
        }
        popup.style.display = 'block';
        setTimeout(() => { popup.style.display = 'none'; }, 2000);
    })
    .catch(err => console.error("Error marking order as paid:", err));
}

// Connection status click
document.getElementById("connection-status").addEventListener("click",()=>{
    if(socket && socket.readyState===WebSocket.OPEN){
        updateConnectionStatus("closing");
        socket.close();
    } else if(!socket || socket.readyState===WebSocket.CLOSED){
        connectSocket();
    }
});

// Search functionality
const searchInput=document.getElementById('order-search');
let searchTimeout=null;
searchInput.addEventListener('input',function(){
    clearTimeout(searchTimeout);
    searchTimeout=setTimeout(()=>{
        const value=searchInput.value.trim();
        if(!value) return;
        const searchNumber=Number(value);
        document.querySelectorAll('.order-card').forEach(div=>{
            if(Number(div.dataset.customerId)===searchNumber){
                displayOrder(div);
                searchInput.value='';
            }
        });
    },300);
});

// Happy Hour toggle
function toggleHappyHour() {
    fetch('/thh/', { method: 'GET' })
        .then(response => {
            if (!response.ok) throw new Error("Network response was not OK");
            return response.json();
        })
        .then(data => { location.reload(); })
        .catch(error => {
            console.error("Error toggling Happy Hour:", error);
            alert("Failed to toggle Happy Hour.");
        });
}

// Clear cupon inputs on load
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.cupon-input').forEach(input => input.value = '');
});

// SB-Kosten Payment JS
document.getElementById('pay-sb-btn').addEventListener('click', () => {
    const reason = document.getElementById('sb-reason').value.trim();
    const price = document.getElementById('sb-price').value.trim();
    const password = document.getElementById('sb-password').value.trim();

    if(!reason || !price || !password){
        alert("Bitte alle Felder ausfüllen!");
        return;
    }

    const url = `/pay_sb_costs/?reason=${encodeURIComponent(reason)}&price=${encodeURIComponent(price)}&password=${encodeURIComponent(password)}`;

    fetch(url, { method: 'GET', headers: {"X-CSRFToken": "{{ csrf_token }}"} })
        .then(res => res.json())
        .then(data => {
            if(data.status === "ok"){
                alert(`SB-Kosten von ${price}€ für "${reason}" hinzugefügt!`);
                document.getElementById('sb-reason').value = '';
                document.getElementById('sb-price').value = '';
                document.getElementById('sb-password').value = '';
                document.getElementById('income').textContent = data.new_income;
            } else {
                alert("Falsches Passwort oder Fehler beim Hinzufügen!");
            }
        })
        .catch(err => console.error("Error paying SB costs:", err));
});
</script>

<style>
.hh-active {
    background: red !important;
    color: white !important;
    border: none !important;
}
.hh-inactive {
    background: green !important;
    color: white !important;
    border: none !important;
}
</style>
{% endblock content %}
