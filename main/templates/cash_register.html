{% extends "base.html" %}

{% block title %}Cash Register{% endblock title %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 80px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
    <h1>Cash Register</h1>
    <h2>Aktuelles Geld: <span id="income">{{ income }}</span>€</h2>

    <div id="connection" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
        <p id="connection-status" style="margin: 0; padding: 5px; border-radius: 4px; cursor: pointer; color: red;">
            Nicht verbunden oder Verbindung wird aufgebaut…
        </p>
    </div>

    <div id="orders">
        {% for order in orders %}
            <div class="order" id="order-{{ order.id }}">
                <p>{{ order.customer.id }}: {{ order.price }}€</p>
                <p>
                    {% for product in order.orderitem_set.all %}
                        {{ product.quantity }} x {{ product.product.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    ({{ order.created_at|date:"d.m.Y H:i" }}/Order ID: {{ order.id }})
                </p>
                <button class="display-pay-button" data-order-id="{{ order.id }}">
                    Display on Pay Screen
                </button>
            </div>
        {% endfor %}
    </div>
</div>

<script>
let socket = null;

// Update connection status indicator
function updateConnectionStatus(state) {
    const statusEl = document.getElementById("connection-status");
    if(state === "connected") {
        statusEl.textContent = "Live-Server verbunden (click to disconnect)";
        statusEl.style.color = "rgba(45, 210, 0, 1)";
    } else if(state === "disconnected") {
        statusEl.textContent = "Nicht verbunden (click to connect)";
        statusEl.style.color = "red";
    } else if(state === "connecting") {
        statusEl.textContent = "Verbindung wird aufgebaut…";
        statusEl.style.color = "orange";
    } else if(state === "closing") {
        statusEl.textContent = "Verbindung wird geschlossen…";
        statusEl.style.color = "darkorange";
    }
}

// Connect WebSocket
function connectSocket() {
    updateConnectionStatus("connecting");
    const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/pay/`);


    socket.onopen = function() {
        updateConnectionStatus("connected");
    };

    socket.onclose = function() {
        updateConnectionStatus("disconnected");
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // Remove order if it was marked as paid
        if(data.paid_order_id) {
            const el = document.getElementById(`order-${data.paid_order_id}`);
            if(el) el.remove();
        }

        // Update orders list
        if(data.orders) {
            const ordersContainer = document.getElementById("orders");
            ordersContainer.innerHTML = ""; // clear current orders

            data.orders.forEach(order => {
                const items = order.items.map(i => `${i.quantity} x ${i.name}`).join(", ");
                const div = document.createElement("div");
                div.classList.add("order");
                div.id = `order-${order.id}`;
                div.innerHTML = `
                    <p>${order.customer_id}: ${order.price}€</p>
                    <p>${items} (Order ID: ${order.id})</p>
                    <button class="display-pay-button" data-order-id="${order.id}">Display on Pay Screen</button>
                `;
                ordersContainer.appendChild(div);
            });

            // Update income
            document.getElementById("income").textContent = data.income;
        }
    };
}

connectSocket();

// Handle display/pay buttons
document.addEventListener("click", function(e) {
    if(e.target.classList.contains("display-pay-button")) {
        const orderId = e.target.dataset.orderId;

        if(!e.target.dataset.displaying) {
            // First click: send order to pay screen
            fetch(`/display_order/${orderId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(res => res.json())
            .then(data => {
                e.target.textContent = "NOW DISPLAYING ORDER ON SCREEN - MARK AS PAYED";
                e.target.dataset.displaying = "true";
            });
        } else {
            // Second click: mark order as paid
            fetch(`${orderId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(res => res.json())
            .then(data => {
                const orderDiv = document.getElementById(`order-${orderId}`);
                if(orderDiv) orderDiv.remove();
            });
        }
    }
});

// Toggle WebSocket connection by clicking status text
document.getElementById("connection-status").addEventListener("click", function() {
    if(socket && socket.readyState === WebSocket.OPEN) {
        updateConnectionStatus("closing");
        socket.close();
    } else if(!socket || socket.readyState === WebSocket.CLOSED) {
        connectSocket();
    }
});

window.addEventListener("beforeunload", () => {
    if(socket) updateConnectionStatus("closing");
});
</script>
{% endblock content %}
