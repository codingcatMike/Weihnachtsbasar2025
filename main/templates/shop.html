{% extends "base.html" %}
{% block title %}Shop{% endblock title %}
{% block content %}
{% load static %}
<script defer>
orders = []
orders_name =  []
function AddProduct(id, name) {
    console.log(id);
    if (id != null && id != "") {
        orders.push(id);
        name = " " + name;
        orders_name.push(name);
        console.log("Produkte im Warenkorb: " + orders_name);
        document.getElementById("orders").innerHTML = "Produkte im Warenkorb: " + orders_name;
    } else {
        console.log("Ungültige Produkt-ID");
        return;
    }
}

function SendOrder() {
    if (orders.length === 0) {
        alert("Bitte fügen Sie Produkte zum Warenkorb hinzu.");
        return;
    }
    const customerId = document.querySelector('input[name="customer_id"]').value;
    if (!customerId) {
        alert("Bitte geben Sie eine Kunden ID ein.");
        return;
    }

    fetch("{% url 'sendOrder' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            customer_id: customerId,
            products: orders,
            shop: "{{shop.id}}"
        })
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            // Zeige die Nachricht aus dem Backend
            throw new Error(data.message || "Unbekannter Fehler vom Server");
        }
        return data;
    })
    .then(data => {
        console.log("Antwort vom Server:", data);
        location.reload();
    })
    .catch(err => {
        console.error("Fehler beim Senden:", err);
        alert("Es gab ein Problem mit der Bestellung:\n" + err.message);
        location.reload()
    });
}

</script>

<!-- Haupt-Container auf 66% Breite, mittig -->
<div class="container" style="width: 66%; margin: 0 auto; text-align: center;">
    <h1>{{ shop.name }}</h1>
    {% if shop.activated == False %}
    <p style="color: orange">Dein Shop ist nochnicht aktiviert, deshalb kannst du keine Orders abschicken. Du kannst trotzdem Produkte erstellen </p>
    {% endif %}

    <div style="margin-bottom: 20px;">
        Kunden ID: 
        <input type="text" 
               name="customer_id" 
               id="customer_id" 
               placeholder="Kunden ID" 
               autocomplete="off" 
               style="background-color: rgb(214, 214, 214);">
    </div>

    {% for product in products %}
        <button style="margin-top: 10px; width: 100%" 
                onclick="AddProduct({{ product.id }}, '{{product.name}}')">
            {{ product.name }} - {{ product.price }}€
        </button><br>
    {% endfor %}

    <button type="submit" 
            style="margin-top: 30px; background-color: rgb(136, 255, 0);" 
            onclick="SendOrder()">Senden</button>

    <button style="margin-top: 20px; background-color: rgb(255, 0, 0);" 
            onclick="location.reload()">Alle Felder Löschen</button>

    <div id="orders" style="margin-top: 20px;">
        Produkte im Warenkorb:
    </div>
</div>

<!-- Floating Button für Settings -->
<button style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; position: fixed; bottom: 10px; right: 10px; background-color: #007bff; color: white; font-size: 24px; padding: 10px; border-radius: 50%; border: none; cursor: pointer;"
        onclick="window.location.href='/Shop/{{ shop.id }}/settings';" 
        title="Shop Settings" 
        aria-label="Shop Settings" 
        tabindex="0" 
        role="button" 
        aria-pressed="false">
    ⚙️
</button>

{% endblock %}
