{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pay Screen</title>
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
            margin: 0px;
        }
        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        tr:nth-child(even) {
            background-color: #dddddd;
        }
        .total-row {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        .qr-container {
            text-align: center;
            margin-top: 20px;
        }
        .qr-container img {
            width: 200px;
            height: 200px;
        }
    </style>
</head>
<body>

<div id="order-container">
    <!-- Order table + QR code will appear here -->
</div>

<script>
const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/pay_screen/`);


socket.onopen = function() {
    console.log("Connected to PayScreen WebSocket");
};

socket.onclose = function() {
    console.log("Disconnected from PayScreen WebSocket");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const container = document.getElementById("order-container");
    console.log("DEBUG order:", data.order);
    console.log("QR Code:", data.order ? data.order.qr_code : "No order");

    // Clear display if order is None
    if (data.order === null) {
        container.innerHTML = "";
        return;
    }

    if (data.paid_order_id) {
    container.innerHTML = "";
}

    if (data.order) {
        const order = data.order;
        let itemsHtml = order.items.map(item =>
            `<tr>
                <td>${item.quantity}</td>
                <td>${item.name}</td>
                <td>${item.price}€</td>
                <td>${(item.quantity * item.price)}€</td>
            </tr>`
        ).join("");

        const tableHtml = `
            <table>
                <tr>
                    <th>Anzahl</th>
                    <th>Produkt</th>
                    <th>Einzelpreis</th>
                    <th>Gesamt</th>
                </tr>
                ${itemsHtml}
                <tr class="total-row">
                    <td colspan="2"><strong>Total (insgesamt):</strong></td>
                    <td colspan="2"><strong>${order.price}€</strong></td>
                </tr>
                <tr class="total-row">
                    <td colspan="2"><strong>Kundennummer:</strong></td>
                    <td colspan="2"><strong>${order.customer_id} (${order.id})</strong></td>
                </tr>
            </table>
            <div class="qr-container">
              <p>Scan this QR code to get your receipt:</p>
              <img src="${order.qr_code}" alt="QR Code">
          </div>
        `;

        container.innerHTML = tableHtml;
    }

    // Optionally handle order removal if it's paid
    if (data.paid_order_id) {
        container.innerHTML = "<p>Keine Bestellung angezeigt</p>";
    }
};
</script>

</body>
</html>
