<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pay Screen</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>
<body>

<table id="orders-table">
    <tr>
        <th>Anzahl</th>
        <th>Produkt</th>
        <th>Einzelpreis</th>
        <th>Total</th>
    </tr>
    {% for product in order.orderitem_set.all %}
    <tr>
        <td>{{ product.quantity }}</td>
        <td>{{ product.product.name }}</td>
        <td>{{ product.product.price }}€</td>
        <td>{{ product.total }}€</td>
    </tr>
    {% endfor %}
    <tr>
        <td></td>
        <td></td>
        <td><strong>Gesamt:</strong></td>
        <td><strong id="total-sum">{{ order.price }}€</strong></td>
    </tr>
</table>

<script>
let socket = new WebSocket(
    (window.location.protocol === "https:" ? "wss://" : "ws://") 
    + window.location.host 
    + "/ws/pay_screen/"
);

socket.onopen = function() {
    console.log("Connected to WebSocket");
};

socket.onclose = function() {
    console.log("Disconnected from WebSocket");
};

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if(data.order) {
        const order = data.order;

        // Replace table rows except for header and total row
        const table = document.getElementById("orders-table");
        table.innerHTML = `
            <tr>
                <th>Anzahl</th>
                <th>Produkt</th>
                <th>Einzelpreis</th>
                <th>Total</th>
            </tr>
        `;

        let totalSum = 0;
        order.items.forEach(product => {
            const row = document.createElement("tr");
            const total = product.quantity * product.price;
            totalSum += total;
            row.innerHTML = `
                <td>${product.quantity}</td>
                <td>${product.name}</td>
                <td>${product.price}€</td>
                <td>${total}€</td>
            `;
            table.appendChild(row);
        });

        // Add total row
        const totalRow = document.createElement("tr");
        totalRow.innerHTML = `
            <td></td>
            <td></td>
            <td><strong>Gesamt:</strong></td>
            <td><strong>${totalSum}€</strong></td>
        `;
        table.appendChild(totalRow);
    }
};
</script>

</body>
</html>
