{% extends "base.html" %}
{% block title %}Shop Settings{% endblock %}

{% block content %}
<div class="container" style="width: 66%; margin: 0 auto; padding: 20px; box-sizing: border-box;">
    <h1>Settings for "{{ shop.name }}"</h1>

    <!-- Back Button -->
    <a href="{% url 'Shop' id=shop.id %}" style="display:inline-block; margin-bottom:20px; text-decoration:none; padding:6px 12px; background-color:#3498db; color:white; border-radius:4px;">‚Üê Back to Shop</a>

    <!-- Rename Shop -->
    {% if actor_level == 3 %}
    <form method="post" style="margin-bottom:30px;">
        {% csrf_token %}
        <input type="hidden" name="rename_shop" value="1">
        <label for="shop_name">Rename Shop:</label>
        <input type="text" id="shop_name" name="shop_name" value="{{ shop.name }}" style="padding:5px; margin-left:5px;">
        <button type="submit" style="padding:5px 10px; margin-left:5px; background-color:#2ecc71; color:white; border:none; border-radius:3px;">Rename</button>
    </form>
    {% endif %}

    <!-- Sellers List -->
    <h2>Sellers</h2>
    <ul>
        {% for su in shop_users %}
        <li style="margin-bottom:10px;">
            {{ su.user.username }} ({{ su.level_name }})
            
            <!-- Level change -->
            {% if actor_level > su.level %}
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ su.user.id }}">
                <select name="new_level" style="padding:3px;">
                    {% for lvl, name in su.allowed_levels %}
                    <option value="{{ lvl }}" {% if lvl == su.level %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" style="padding:3px 6px; background-color:#f1c40f; color:white; border:none; border-radius:3px;">Change</button>
            </form>
            {% endif %}

            <!-- Remove Seller -->
            {% if actor_level > su.level and request.user != su.user %}
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="remove_seller_id" value="{{ su.user.id }}">
                <button type="submit" style="padding:3px 6px; background-color:#e74c3c; color:white; border:none; border-radius:3px;">Remove</button>
            </form>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
        <h2>Add User</h2>
    <div style="position: relative; margin-bottom:30px;">
        <input type="text" id="user-search" placeholder="Type username..." style="padding:5px; width:250px;">
        <ul id="user-results" style="list-style:none; padding:5px; margin:0; border:1px solid #ccc; position:absolute; width:250px; background:white; z-index:10; display:none;"></ul>
    </div>
    <form method="post" id="add-user-form" style="display:none;">
        {% csrf_token %}
        <input type="hidden" name="add_user_id" id="add_user_id">
        <button type="submit" style="padding:5px 10px; background-color:#2ecc71; color:white; border:none; border-radius:3px;">Add User</button>
    </form>

    <!-- Product Creation Form -->
    <h2>Create Product</h2>
    <form method="post" style="margin-top:20px;">
        {% csrf_token %}
        <input type="hidden" name="create_product" value="1">
        {{ form.as_p }}
        <button type="submit" style="padding:6px 12px; background-color:#2ecc71; color:white; border:none; border-radius:4px;">Create Product</button>
    </form>
</div>
<script>
const searchInput = document.getElementById('user-search');
const resultsList = document.getElementById('user-results');
const addUserForm = document.getElementById('add-user-form');
const addUserInput = document.getElementById('add_user_id');

searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    if (!query) {
        resultsList.style.display = 'none';
        return;
    }

    fetch("{% url 'search_users' shop.id %}?q=" + encodeURIComponent(query))
        .then(res => res.json())
        .then(data => {
            resultsList.innerHTML = '';
            if (data.length === 0) {
                resultsList.style.display = 'none';
                return;
            }

            data.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user.username;
                li.style.padding = '5px';
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    addUserInput.value = user.id;
                    addUserForm.style.display = 'inline-block';
                    searchInput.value = user.username;
                    resultsList.style.display = 'none';
                });
                resultsList.appendChild(li);
            });
            resultsList.style.display = 'block';
        });
});

// Hide results if clicked outside
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
        resultsList.style.display = 'none';
    }
});
</script>
<style>
#user-results li {
    color: black;
}
</style>

{% endblock %}