<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kundenbestellungen</title>
<style>
  body{font-family:Arial, sans-serif;background:#f0f2f5;padding:15px;margin:0}
  h1{text-align:center;color:#333;font-size:1.8rem;margin-bottom:10px}
  #customer-section{display:flex;flex-direction:column;align-items:center;margin-bottom:10px;gap:10px}
  #customer-id{font-size:1rem;padding:8px 10px;width:80%;max-width:250px;text-align:center;box-sizing:border-box}
  #coupon-note{font-size:0.9rem;color:#555;text-align:center;margin-bottom:15px}
  #orders-container{display:flex;flex-direction:column;gap:10px;margin:0 auto;width:95%;max-width:500px}
  .order-card{background:#fff;border-left:5px solid #4caf50;padding:12px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);display:flex;flex-direction:column;gap:5px;word-wrap:break-word;position:relative;overflow:hidden}
  .ticket{background:#fff3cd;border-left:5px solid #ffc107;padding:8px;border-radius:5px;font-weight:bold;color:#856404;margin-top:5px;text-align:center}
  .ticket strong{display:block;color:#000;margin-top:5px}

  /* Fullscreen overlay for messages */
  .fullscreen-message {
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85);
    display:flex; justify-content:center; align-items:center;
    flex-direction: column;
    color:#fff; font-size:3rem; text-align:center;
    z-index:9999; opacity:0; transition: opacity 0.3s;
  }
  .fullscreen-message p {
    margin:0.5em 0;
  }
  #paid-overlay p { font-size:2rem; color:#28a745; }
  #pickup-overlay p { font-size:2.5rem; color:#ffcc00; }
</style>
</head>
<body>
<h1>Live-Bestellungen</h1>
<div id="customer-section">
  <label for="customer-id">Kunden-ID:</label>
  <input id="customer-id" type="text" readonly />
</div>
<div id="coupon-note">Gutscheine werden an der Kasse automatisch angewendet.</div>
<div id="orders-container"></div>

<!-- Paid message overlay -->
<div id="paid-overlay" class="fullscreen-message">
  <p id="paid-message">Bezahlt!</p>
  <p id="paid-price"></p>
</div>

<!-- Pickup message overlay -->
<div id="pickup-overlay" class="fullscreen-message">
  <p>Guten Appetit!</p>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const customerInput = document.getElementById("customer-id");
  const ordersContainer = document.getElementById("orders-container");
  const paidOverlay = document.getElementById("paid-overlay");
  const paidPriceEl = document.getElementById("paid-price");
  const paidMessageEl = document.getElementById("paid-message");
  const pickupOverlay = document.getElementById("pickup-overlay");

  // Paid quotes
  const quotes = [
    "Danke, dass du gekauft hast ‚Äì jetzt k√∂nnen wir die Lehrer mit Gl√ºhwein bestechen‚Ä¶ √§h, motivieren! üéÑ",
    "Du bist cooler als der letzte freie Platz in der ersten Reihe ‚Äì danke f√ºr deinen Einkauf! üè´",
    "Danke! Dein Geld rettet unsere Schul-Weihnachtskekse vor dem Hungertod. üç™",
    "Ho Ho Ho! Ohne dich w√§ren unsere Pl√§tzchen bald nur Zuckerstaub. ‚ú®",
    "Danke! Dein Kauf bringt mehr Glitzer in die Schule als der Chemiesaal nach einem Versuch. üß™",
    "Du hast gerade unseren Schulsanit√§tsdienst gl√ºcklich gemacht ‚Äì endlich Pausen f√ºr uns! ‚è∞",
    "Danke! Dein Geld hilft uns, die Weihnachtsdeko bis zur Decke zu stapeln. üéÑ",
    "Du bist unser Schul-Weihnachtsheld ‚Äì Umhang optional, Kekse Pflicht. ü¶∏",
    "Danke! Mit deinem Einkauf k√∂nnen wir die Rentiere‚Ä¶ √§h, die Lehrer, gl√ºcklich stimmen. ü¶å",
    "Ho Ho Ho! Dein Geld bringt mehr Freude als die letzte Stunde vor den Ferien. üéÅ",
    "Danke, dass du gekauft hast ‚Äì unsere Klassenkasse tanzt gerade Lambada. üíÉ",
    "Dein Einkauf = Bonuspunkte bei uns (leider nicht bei den Lehrern). üòé",
    "Danke! Ohne dich m√ºssten wir Weihnachtspl√§tzchen gegen Hausaufgaben tauschen. üìöüç™",
    "Du bist offizieller Mit-Gl√ºhwein- und Kekstest-Manager ‚Äì danke! ‚òï",
    "Danke, dass du gekauft hast ‚Äì unsere Pausen sind jetzt ein bisschen s√º√üer. üç¨",
    "Dein Kauf rettet die Schul-Weihnachts-Party vor Langeweile ‚Äì hurra! üéâ",
    "Danke! Du bist wie ein Schneemann in der Sonne: √ºberraschend cool. ‚õÑ",
    "Dein Geld = mehr Lametta + weniger Mathe-Tr√§nen. Danke! ‚ú®",
    "Danke! Du machst unseren Weihnachtsbasar epischer als den Chemie-Experiment-Unfall. üß™üí•",
    "Du bist der Grund, warum unser Klassen-Weihnachtsbaum nicht traurig ist ‚Äì danke! üéÑ"
  ];

  // Pickup quotes
  const pickupQuotes = [
    "Danke, dass du zugeschlagen hast ‚Äì unsere Weihnachtsfreude steigt wie hei√üer Kakao! ‚òï‚ú®",
    "Ho Ho Ho! Dein Einkauf bringt extra Glitzer in unsere Teller. üéÑ",
    "Danke! Du hast gerade unser Weihnachts-Gl√ºckslevel aufgef√ºllt. üåü",
    "Dein Beitrag sorgt f√ºr festliche Stimmung in jedem Bissen ‚Äì √§h, Moment. üéâ",
    "Danke, dass du gekauft hast ‚Äì unsere Weihnachtsmagie wird dadurch gr√∂√üer. üßù‚Äç‚ôÇÔ∏è",
    "Du bist der Grund, warum die Schule heute noch s√º√üer schmeckt! üòã",
    "Ho Ho Ho! Dein Einkauf hat unsere Weihnachtsstimmung zum Kochen gebracht. üçΩÔ∏è",
    "Danke! Dank dir tanzen die Lichterketten und die Teller im Takt. üíÉ‚ú®",
    "Dein Beitrag sorgt f√ºr Extra-Spa√ü auf dem Weihnachtsbasar! üéÑ",
    "Danke! Du hast gerade das Weihnachtschaos k√∂stlich gerettet. üéâ",
    "Ho Ho Ho! Dein Einkauf macht unsere Klassenzimmer fr√∂hlicher als je zuvor. üè´",
    "Danke, dass du gekauft hast ‚Äì jetzt glitzert die Weihnachtsstimmung richtig. ‚ú®",
    "Du bist offiziell Teil unseres festlichen Gl√ºcks-Teams ‚Äì danke! üéÑ",
    "Danke! Dein Beitrag bringt festliche Energie in jeden Raum. ‚ö°",
    "Ho Ho Ho! Dank dir wird unser Basar ein bisschen magischer. üßù‚Äç‚ôÄÔ∏è",
    "Danke! Du hast unser Weihnachts-Barometer auf Maximum gestellt. üåü",
    "Dein Einkauf = mehr Freude, weniger Langeweile. Danke! üòé",
    "Danke, dass du gekauft hast ‚Äì unser Basar tanzt jetzt im Festtagsrhythmus. üíÉ",
    "Ho Ho Ho! Dein Beitrag bringt Glanz in jede Ecke unseres Basars. ‚ú®",
    "Danke! Du machst unseren Weihnachtsbasar ein St√ºckchen leckerer‚Ä¶ und magischer. üéÑ"
  ];

  // Track already shown overlays persistently
  let shownPaidOrders = new Set(JSON.parse(localStorage.getItem('shownPaidOrders') || '[]'));
  let shownPickupOrders = new Set(JSON.parse(localStorage.getItem('shownPickupOrders') || '[]'));

  function getCookie(name){
    let cookieValue = null;
    if(document.cookie && document.cookie !== ''){
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if(c.startsWith(name + '=')) cookieValue = decodeURIComponent(c.substring(name.length + 1));
      });
    }
    return cookieValue;
  }

  async function createNewCid(){
    const res = await fetch('/customer', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
      body: '{}'
    });
    if(!res.ok) throw new Error('Failed to create new cid');
    const data = await res.json();
    return data.cid;
  }

  async function checkCidOnServer(cid){
    const res = await fetch(`/customer?cid=${cid}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    if(!res.ok) throw new Error('Failed to check cid');
    return await res.json();
  }

  function showOverlay(overlay, duration=3000){
    overlay.style.opacity = 1;
    clearTimeout(overlay._timeout);
    overlay._timeout = setTimeout(()=>{
      overlay.style.opacity = 0;
    }, duration);
  }

  function renderOrder(order){
    ordersContainer.innerHTML = ''; 
    const card = document.createElement('div');
    card.className = 'order-card';
    card.id = 'order-card-' + order.id;
    card.innerHTML = `
      <div class="products">${order.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</div>
      <div class="price">‚Ç¨${order.price.toFixed(2)}</div>
    `;

    // Show ticket if needs kitchen and not yet picked up
    if(order.payed && !order.picked_up && order.needs_kitchen){
      const ticket = document.createElement('div');
      ticket.className = 'ticket';
      ticket.innerHTML = `
        Ticket: ${order.customer_id}
        <strong>Gehen Sie in die K√ºche, dort k√∂nnen Sie Ihr Essen mit diesem Ticket abholen.</strong>
      `;
      card.appendChild(ticket);
    }

    // Paid overlay: only once per order
    if(order.payed && !shownPaidOrders.has(order.id)){
      paidPriceEl.textContent = `‚Ç¨${order.price.toFixed(2)}`;
      const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
      paidMessageEl.textContent = randomQuote;
      showOverlay(paidOverlay, 3000);

      shownPaidOrders.add(order.id);
      localStorage.setItem('shownPaidOrders', JSON.stringify([...shownPaidOrders]));
    }

    // Pickup overlay: only once per order
    if(order.picked_up && order.needs_kitchen && !shownPickupOrders.has(order.id)){
      const randomPickupQuote = pickupQuotes[Math.floor(Math.random() * pickupQuotes.length)];
      pickupOverlay.querySelector('p').textContent = randomPickupQuote;
      showOverlay(pickupOverlay, 4000);

      shownPickupOrders.add(order.id);
      localStorage.setItem('shownPickupOrders', JSON.stringify([...shownPickupOrders]));
    }

    ordersContainer.appendChild(card);
  }

  let cid = localStorage.getItem('customer_id');

  try {
    if(!cid){
      cid = await createNewCid();
      localStorage.setItem('customer_id', cid);
    } else {
      const check = await checkCidOnServer(cid);
      if(check.picked_up === true){
        cid = await createNewCid();
        localStorage.setItem('customer_id', cid);
      } else {
        if(Array.isArray(check.orders) && check.orders.length > 0){
          renderOrder(check.orders[0]);
        }
        if(check.cid) {
          cid = check.cid;
          localStorage.setItem('customer_id', cid);
        }
      }
    }
    customerInput.value = cid;
  } catch (err) {
    console.error('Initialization error:', err);
    if(cid) customerInput.value = cid;
  }

  try {
    const ws = new WebSocket(`wss://${window.location.host}/ws/customer/`);
    ws.addEventListener('open', () => {
      ws.send(JSON.stringify({ cid }));
    });
    ws.addEventListener('message', (ev) => {
      try {
        const order = JSON.parse(ev.data);
        renderOrder(order);
      } catch (e) {
        console.error('WS message parse error', e);
      }
    });
  } catch (e) {
    console.error('WebSocket error', e);
  }
});
</script>
</body>
</html>
